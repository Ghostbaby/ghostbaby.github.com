
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>GhostBaby`s Area</title>
	<meta name="author" content="GhostBaby">

	
	<meta name="description" content="jstat:是JDK自带的虚拟机统计监测工具
在命令行中执行jstat 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
Usage: jstat -help|-options jstat -&lt;option&gt; [-t] [-h&lt &hellip;">
	

	<link href="/atom.xml" rel="alternate" title="GhostBaby`s Area" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
	

	
</head>

<body>
	<header id="header" class="inner"><nav><ul>
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul></nav>
</header>
	<div id="content" class="inner">


	<article class="post"><header>
  
  <h1 class="title"><a href="/blog/2013/08/21/javaxu-ni-ji-de-tong-ji-jian-ce-gong-ju-jstat/">Java虚拟机的统计监测工具:jstat</a></h1>
  
  








	
		<time datetime="2013-08-21T10:05:00+08:00">
			<span class="day">21</span><span class="month">Aug</span>
		</time>
	

</header>
<div class="entry-content">
  
    <p>jstat:是JDK自带的虚拟机统计监测工具
在命令行中执行jstat</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Usage: jstat -help|-options
</span><span class='line'>       jstat -&lt;option&gt; [-t] [-h&lt;lines&gt;] &lt;vmid&gt; [&lt;interval&gt; [&lt;count&gt;]]
</span><span class='line'>
</span><span class='line'>Definitions:
</span><span class='line'>  &lt;option&gt;      An option reported by the -options option
</span><span class='line'>  &lt;vmid&gt;        Virtual Machine Identifier. A vmid takes the following form:
</span><span class='line'>                     &lt;lvmid&gt;[@&lt;hostname&gt;[:&lt;port&gt;]]
</span><span class='line'>                Where &lt;lvmid&gt; is the local vm identifier for the target
</span><span class='line'>                Java virtual machine, typically a process id; &lt;hostname&gt; is
</span><span class='line'>                the name of the host running the target Java virtual machine;
</span><span class='line'>                and &lt;port&gt; is the port number for the rmiregistry on the
</span><span class='line'>                target host. See the jvmstat documentation for a more complete
</span><span class='line'>                description of the Virtual Machine Identifier.
</span><span class='line'>  &lt;lines&gt;       Number of samples between header lines.
</span><span class='line'>  &lt;interval&gt;    Sampling interval. The following forms are allowed:
</span><span class='line'>                    &lt;n&gt;["ms"|"s"]
</span><span class='line'>                Where &lt;n&gt; is an integer and the suffix specifies the units as
</span><span class='line'>                milliseconds("ms") or seconds("s"). The default units are "ms".
</span><span class='line'>  &lt;count&gt;       Number of samples to take before terminating.
</span><span class='line'>  -J&lt;flag&gt;      Pass &lt;flag&gt; directly to the runtime system.</span></code></pre></td></tr></table></div></figure>


<p>通过不的option可以查看JVM当前的各种信息,比如:类, 内存等
参数主要有:</p>

<p>class: 类装载器统计
compiler: HotSpot JVM实时编译统计
gc: 垃圾回收堆统计
gccapacity: 内存统计
gccause: 垃圾回收统计信息，包括回收事件
gcnew: 对象创建情况
gcnewcapacity: 对象创建内存情况
gcold: 老年代和永久代统计
gcoldcapacity: 老年代统计
gcpermcapacity: 永久代统计
gcutil: 垃圾收集的统计
printcompilation: HotSpot编译器的方法统计</p>

<p>执行: jstat -class 2000 结果如下
加载类的个数  加载类的大小  卸载类的个数  卸载类的大小  加载和卸载所占用的时间
Loaded      Bytes       Unloaded    Bytes       Time
23624       29798.8     1346        1225.8      218.34</p>

<p>执行: jstat -compiler 2000 结果如下</p>

<p>编译的个数     编译失败的个数       无效的编译个数       编译所用时间  最后一次编译失败的类型       最后一次编译失败的方法
Compiled    Failed          Invalid         Time        FailedType          FailedMethod
1629        1           0           0.86        1               org/springframework/asm/ClassReader accept</p>

<p>执行: jstat -gc 2000 结果如下</p>

<p>Survivor 0的大小(KB) Survivor 1的大小(KB) Survivor 0使用大小 Survivor 1使用大小 Eden大小 Eden使用大小 Old大小 Old使用大小 Permanent大小 Permanent使用大小 Young generation GC次数 Young generation GC时间 Full GC次数 Full GC时间 所有GC时间
S0C S1C S0U S1U EC EU OC OU PC PU YGC YGCT FGC FGCT GCT
14016.0 14016.0 2932.5 0.0 112192.0 96465.9 280212.0 227679.0 116480.0 116338.6 418 37.823 34 59.928 97.751</p>

<p>执行: jstat -gccapacity 2000 结果如下</p>

<p>新生代最小 新生代最大 当前新生代(NGC=S0C+S1C+EC) Survivor 0大小 Survivor 1大小 Eden大小 老年代最小 老年代最大 老年代当前大小 老年代当前容量 永久代最小 永久代最大 当前永久代大小 永久代容量 Young GC次数 Full GC次数
NGCMN NGCMX NGC S0C S1C EC OGCMN OGCMX OGC OC PGCMN PGCMX PGC PC YGC FGC
13632.0 174720.0 140224.0 14016.0 14016.0 112192.0 27328.0 349568.0 280212.0 280212.0 12288.0 262144.0 116480.0 116480.0 419 34</p>

<p>执行: jstat -gccause 2000 结果如下</p>

<p>Survivor 0使用率 Survivor 1使用率 Eden使用率 Old使用率 Permanent使用率 YoungGC次数 YoungGC时间 FullGC次数 FullGC时间 GC总时间 上一次GC原因 当前GC原因
S0 S1 E O P YGC YGCT FGC FGCT GCT LGCC GCC
0.00 21.85 20.68 81.25 99.88 419 37.836 34 59.928 97.764 unknown GCCause No GC</p>

<p>执行: jstat -printcompilation 2000 结果如下</p>

<p>编译次数 方法的字节码的字节数 编译类型 编译方法
Compiled Size Type Method
13575 17 1 org/eclipse/swt/widgets/Caret hasFocus</p>

  
  
  <footer class="meta">
    



    
  </footer>
  
</div>
</article>


	<article class="post"><header>
  
  <h1 class="title"><a href="/blog/2013/08/21/jvm-sheng-cheng-javacorehe-heapdumpwen-jian/">Jvm 生成javacore和heapdump文件</a></h1>
  
  








	
		<time datetime="2013-08-21T10:03:00+08:00">
			<span class="day">21</span><span class="month">Aug</span>
		</time>
	

</header>
<div class="entry-content">
  
    <p>（1）如果使用Oracle JVM也就是标准的SUN JVM（SUN已被oracle收购）
当内存溢出时生成heapdump文件配置如下</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-Xloggc:${目录}/temp_gc.log           （GC日志文件）
</span><span class='line'>-XX:+HeapDumpOnOutOfMemoryError       （内存溢出时生成heapdump文件）
</span><span class='line'>-XX:HeapDumpPath=${目录}              （heapdump文件存放位置）</span></code></pre></td></tr></table></div></figure>


<p>如果要即时动态生成heapdump文件可以使用jmap命令，jdk6.0已取消了-XX:+HeapDumpOnCtrlBreak配置参数通过ctrl+break的方式。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>jmap -dump:format=b,file=temp_heapdump.hprof &lt;pid&gt;</span></code></pre></td></tr></table></div></figure>


<p>（2）HP JVM</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-Xverbosegc:file=${目录}/temp_gc.log  （GC日志文件）
</span><span class='line'>-XX:+HeapDumpOnOutOfMemoryError       （内存溢出时生成heapdump文件）
</span><span class='line'>-XX:+HeapDumpOnCtrlBreak              （可以通过ctrl+break组合键动态生成heapdump文件）
</span><span class='line'>-XX:HeapDumpPath=${目录}              （heapdump文件存放位置）</span></code></pre></td></tr></table></div></figure>


<p>（3）IBM JVM</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>非windows操作系统环境中
</span><span class='line'>-XverboseGClog: ${目录}/temp_gc.log   （GC日志文件）
</span><span class='line'>-Xdump:heap:events=user,file=${目录}/pid%uid%pid.phd
</span><span class='line'>表示可以根据需要通过kill -3 &lt;pid&gt;产生DUMP文件，%uid和%pid为变量</span></code></pre></td></tr></table></div></figure>


<p>windows操作系统环境中</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>启动wsadmin,进入wsadmin环境
</span><span class='line'>wsadmin&gt; set jvm [$AdminControl completeObjectName type=JVM,process=server1,*]
</span><span class='line'>wsadmin&gt; $AdminControl invoke $jvm generateHeapDump
</span><span class='line'>wsadmin&gt; $AdminControl invoke $jvm dumpThreads</span></code></pre></td></tr></table></div></figure>


<p>这句要特地说明，如果你的应用负载很高，堆栈已经要满了，千万不用。生成DUMP文件类似于目前堆栈的镜像，会占用很多资源。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>01.jmap -dump:format=b,file=temp_heapdump.hprof &lt;pid&gt;</span></code></pre></td></tr></table></div></figure>


<p>temp_heapdump_1360_2.hprof  生成类似的文件，基本跟你目前堆栈使用大小持平。文件生成之后，就开始用 IBM HeapAnalyzer  进行分析。</p>

  
  
  <footer class="meta">
    



    
  </footer>
  
</div>
</article>


	<article class="post"><header>
  
  <h1 class="title"><a href="/blog/2013/08/21/ibm-heapanalyzer/">IBM HeapAnalyzer</a></h1>
  
  








	
		<time datetime="2013-08-21T10:00:00+08:00">
			<span class="day">21</span><span class="month">Aug</span>
		</time>
	

</header>
<div class="entry-content">
  
    <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>http://pan.baidu.com/share/link?shareid=4106270763&uk=3224714883</span></code></pre></td></tr></table></div></figure>


<p>HeapAnalyzer 是 IBM 的一个用来分析 Java 程序的内存堆使用情况的图形化工具。</p>

  
  
  <footer class="meta">
    



    
  </footer>
  
</div>
</article>


	<article class="post"><header>
  
  <h1 class="title"><a href="/blog/2013/08/21/tong-guo-deng-lu-ipji-lu-linuxsuo-you-yong-hu-deng-lu-suo-cao-zuo-de-ri-zhi/">通过登陆IP记录Linux所有用户登录所操作的日志</a></h1>
  
  








	
		<time datetime="2013-08-21T09:58:00+08:00">
			<span class="day">21</span><span class="month">Aug</span>
		</time>
	

</header>
<div class="entry-content">
  
    <p>/etc/profile 在末尾添加如下代码</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>history
</span><span class='line'>USER=`whoami`
</span><span class='line'>USER_IP=`who -u am i 2&gt;/dev/null| awk '{print $NF}'|sed -e 's/[()]//g'`
</span><span class='line'>if [ "$USER_IP" = "" ]; then
</span><span class='line'>USER_IP=`hostname`
</span><span class='line'>fi
</span><span class='line'>if [ ! -d /tmp/history ]; then
</span><span class='line'>mkdir /tmp/history
</span><span class='line'>chmod 777 /tmp/history
</span><span class='line'>fi
</span><span class='line'>if [ ! -d /tmp/history/${LOGNAME} ]; then
</span><span class='line'>mkdir /tmp/history/${LOGNAME}
</span><span class='line'>chmod 300 /tmp/history/${LOGNAME}
</span><span class='line'>fi
</span><span class='line'>export HISTSIZE=4096
</span><span class='line'>DT=`date +"%Y-%m-%d_%H:%M:%S"`
</span><span class='line'>export HISTFILE="/tmp/history/${LOGNAME}/${USER}@${USER_IP}_history.$DT"
</span><span class='line'>chmod 600 /tmp/history/${LOGNAME}/*history* 2&gt;/dev/null</span></code></pre></td></tr></table></div></figure>


<p>通过上面的脚本代码可以看出来，在系统的/tmp下就新建了个history目录（这个目录可以自定义），在目录中记录了所有的登陆过系统的用户和IP地址，这也是监测系统安全的方法之一。在进行一系列的操作之后，我们进入/tmp/history目录查看历史记录。</p>

  
  
  <footer class="meta">
    



    
  </footer>
  
</div>
</article>


	<article class="post"><header>
  
  <h1 class="title"><a href="/blog/2013/08/19/rpmdb-unable-to-join-the-environmentjie-jue-ban-fa/">Rpmdb: Unable to Join the Environment解决办法</a></h1>
  
  








	
		<time datetime="2013-08-19T16:47:00+08:00">
			<span class="day">19</span><span class="month">Aug</span>
		</time>
	

</header>
<div class="entry-content">
  
    <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /var/lib/rpm/
</span><span class='line'>mkdir db_bak
</span><span class='line'>mv db.* db_bak(最后看到几个__db.00*文件，我也给移走了，果然见效）
</span><span class='line'>rpm --rebuilddb     重建rpm数据库
</span><span class='line'>yum clean all</span></code></pre></td></tr></table></div></figure>


  
  
  <footer class="meta">
    



    
  </footer>
  
</div>
</article>


	<article class="post"><header>
  
  <h1 class="title"><a href="/blog/2013/08/19/openstackan-zhuang-rabbitmq-serverxiao-xi-dui-lie-shi-chu-xian-cuo-wu/">Openstack安装rabbitmq-server消息队列时出现错误</a></h1>
  
  








	
		<time datetime="2013-08-19T16:06:00+08:00">
			<span class="day">19</span><span class="month">Aug</span>
		</time>
	

</header>
<div class="entry-content">
  
    <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Unpacking rabbitmq-server (from .../rabbitmq-server_2.5.0-1ubuntu2_all.deb) ...
</span><span class='line'>Processing triggers for man-db ...
</span><span class='line'>Processing triggers for ureadahead ...
</span><span class='line'>Setting up rabbitmq-server (2.5.0-1ubuntu2) ...
</span><span class='line'>Starting rabbitmq-server: FAILED - check /var/log/rabbitmq/startup_{log, _err}
</span><span class='line'>rabbitmq-server.
</span><span class='line'>invoke-rc.d: inits_cript rabbitmq-server, action "start" failed.
</span><span class='line'>dpkg: error processing rabbitmq-server (--configure):
</span><span class='line'>subprocess installed post-installation s_cript returned error exit status 1
</span><span class='line'>Errors were encountered while processing:
</span><span class='line'>rabbitmq-server
</span><span class='line'>E: Sub-process /usr/bin/dpkg returned an error code (1)</span></code></pre></td></tr></table></div></figure>


<p>openstack安装rabbitmq-server消息队列时出现以下错误：</p>

<p>因为安装完成后，在启动rabbitmq-server时会检测hostname和hosts记录的对应关系
解决方法：
查看hostname</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># hostname 
</span><span class='line'>ubuntu6</span></code></pre></td></tr></table></div></figure>


<p>配置hosts文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat /etc/hosts |grep ubuntu6
</span><span class='line'>127.0.0.1 ubuntu6</span></code></pre></td></tr></table></div></figure>


<p>重启服务：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/init.d/rabbitmq-server start</span></code></pre></td></tr></table></div></figure>




  
  
  <footer class="meta">
    



    
  </footer>
  
</div>
</article>


	<article class="post"><header>
  
  <h1 class="title"><a href="/blog/2013/08/19/nova-rootwrap-require-configuration-file-as-argument/">Nova-rootwrap Require Configuration File as Argument</a></h1>
  
  








	
		<time datetime="2013-08-19T16:04:00+08:00">
			<span class="day">19</span><span class="month">Aug</span>
		</time>
	

</header>
<div class="entry-content">
  
    <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nova root wrapper requires a configuration file as argument but devstack doesn't feed it. This error was reported in the log of nova-volume and nova-network service.
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>===========================nova-network log==========================
</span><span class='line'>2012-06-28 17:17:49 DEBUG nova.utils [-] ['sudo', '/usr/local/bin/nova-rootwrap', 'iptables-save', '-t', 'filter'] failed. Retrying. from (pi
</span><span class='line'>d=9143) execute /opt/stack/nova/nova/utils.py:197
</span><span class='line'>2012-06-28 17:17:50 DEBUG nova.utils [-] Running cmd (subprocess): sudo /usr/local/bin/nova-rootwrap iptables-save -t filter from (pid=9143)
</span><span class='line'>execute /opt/stack/nova/nova/utils.py:168
</span><span class='line'>2012-06-28 17:17:50 DEBUG nova.utils [-] Result was 97 from (pid=9143) execute /opt/stack/nova/nova/utils.py:184
</span><span class='line'>Traceback (most recent call last):
</span><span class='line'>  File "/usr/lib/python2.7/dist-packages/eventlet/hubs/hub.py", line 336, in fire_timers
</span><span class='line'>    timer()
</span><span class='line'>  File "/usr/lib/python2.7/dist-packages/eventlet/hubs/timer.py", line 56, in __call__
</span><span class='line'>    cb(*args, **kw)
</span><span class='line'>  File "/usr/lib/python2.7/dist-packages/eventlet/greenthread.py", line 192, in main
</span><span class='line'>    result = function(*args, **kwargs)
</span><span class='line'>  File "/opt/stack/nova/nova/service.py", line 110, in run_server
</span><span class='line'>    server.start()
</span><span class='line'>  File "/opt/stack/nova/nova/service.py", line 182, in start
</span><span class='line'>    self.manager.init_host()
</span><span class='line'>  File "/opt/stack/nova/nova/network/manager.py", line 1766, in init_host
</span><span class='line'>    self.l3driver.initialize()
</span><span class='line'>  File "/opt/stack/nova/nova/network/l3.py", line 82, in initialize
</span><span class='line'>    linux_net.init_host()
</span><span class='line'>  File "/opt/stack/nova/nova/network/linux_net.py", line 447, in init_host
</span><span class='line'>    add_snat_rule(ip_range)
</span><span class='line'>  File "/opt/stack/nova/nova/network/linux_net.py", line 437, in add_snat_rule
</span><span class='line'>    iptables_manager.apply()
</span><span class='line'>  File "/opt/stack/nova/nova/utils.py", line 672, in inner
</span><span class='line'>    retval = f(*args, **kwargs)
</span><span class='line'>  File "/opt/stack/nova/nova/network/linux_net.py", line 333, in apply
</span><span class='line'>    attempts=5)
</span><span class='line'>  File "/opt/stack/nova/nova/network/linux_net.py", line 828, in _execute
</span><span class='line'>    return utils.execute(*cmd, **kwargs)
</span><span class='line'>  File "/opt/stack/nova/nova/utils.py", line 191, in execute
</span><span class='line'>    cmd=' '.join(cmd))
</span><span class='line'>ProcessExecutionError: Unexpected error while running command.
</span><span class='line'>Command: sudo /usr/local/bin/nova-rootwrap iptables-save -t filter
</span><span class='line'>Exit code: 97
</span><span class='line'>Stdout: '/usr/local/bin/nova-rootwrap: Incorrect configuration file: iptables-save\n'
</span><span class='line'>Stderr: ''
</span><span class='line'>2012-06-28 17:17:50 CRITICAL nova [-] Unexpected error while running command.
</span><span class='line'>Command: sudo /usr/local/bin/nova-rootwrap iptables-save -t filter
</span><span class='line'>Exit code: 97
</span><span class='line'>Stdout: '/usr/local/bin/nova-rootwrap: Incorrect configuration file: iptables-save\n'
</span><span class='line'>Stderr: ''
</span><span class='line'>2012-06-28 17:17:50 TRACE nova Traceback (most recent call last):
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/opt/stack/nova/bin/nova-network", line 48, in &lt;module&gt;
</span><span class='line'>2012-06-28 17:17:50 TRACE nova _launcher.wait()
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/opt/stack/nova/nova/service.py", line 149, in wait
</span><span class='line'>2012-06-28 17:17:50 TRACE nova service.wait()
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/usr/lib/python2.7/dist-packages/eventlet/greenthread.py", line 166, in wait
</span><span class='line'>2012-06-28 17:17:50 TRACE nova return self._exit_event.wait()
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/usr/lib/python2.7/dist-packages/eventlet/event.py", line 116, in wait
</span><span class='line'>2012-06-28 17:17:50 TRACE nova return hubs.get_hub().switch()
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/usr/lib/python2.7/dist-packages/eventlet/hubs/hub.py", line 177, in switch
</span><span class='line'>2012-06-28 17:17:50 TRACE nova return self.greenlet.switch()
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/usr/lib/python2.7/dist-packages/eventlet/greenthread.py", line 192, in main
</span><span class='line'>2012-06-28 17:17:50 TRACE nova result = function(*args, **kwargs)
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/opt/stack/nova/nova/service.py", line 110, in run_server
</span><span class='line'>2012-06-28 17:17:50 TRACE nova server.start()
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/opt/stack/nova/nova/service.py", line 182, in start
</span><span class='line'>2012-06-28 17:17:50 TRACE nova self.manager.init_host()
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/opt/stack/nova/nova/network/manager.py", line 1766, in init_host
</span><span class='line'>2012-06-28 17:17:50 TRACE nova self.l3driver.initialize()
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/opt/stack/nova/nova/network/l3.py", line 82, in initialize
</span><span class='line'>2012-06-28 17:17:50 TRACE nova linux_net.init_host()
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/opt/stack/nova/nova/network/linux_net.py", line 447, in init_host
</span><span class='line'>2012-06-28 17:17:50 TRACE nova add_snat_rule(ip_range)
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/opt/stack/nova/nova/network/linux_net.py", line 437, in add_snat_rule
</span><span class='line'>2012-06-28 17:17:50 TRACE nova iptables_manager.apply()
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/opt/stack/nova/nova/utils.py", line 672, in inner
</span><span class='line'>2012-06-28 17:17:50 TRACE nova retval = f(*args, **kwargs)
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/opt/stack/nova/nova/network/linux_net.py", line 333, in apply
</span><span class='line'>2012-06-28 17:17:50 TRACE nova attempts=5)
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/opt/stack/nova/nova/network/linux_net.py", line 828, in _execute
</span><span class='line'>2012-06-28 17:17:50 TRACE nova return utils.execute(*cmd, **kwargs)
</span><span class='line'>2012-06-28 17:17:50 TRACE nova File "/opt/stack/nova/nova/utils.py", line 191, in execute
</span><span class='line'>2012-06-28 17:17:50 TRACE nova cmd=' '.join(cmd))
</span><span class='line'>2012-06-28 17:17:50 TRACE nova ProcessExecutionError: Unexpected error while running command.
</span><span class='line'>2012-06-28 17:17:50 TRACE nova Command: sudo /usr/local/bin/nova-rootwrap iptables-save -t filter
</span><span class='line'>2012-06-28 17:17:50 TRACE nova Exit code: 97
</span><span class='line'>2012-06-28 17:17:50 TRACE nova Stdout: '/usr/local/bin/nova-rootwrap: Incorrect configuration file: iptables-save\n'
</span><span class='line'>2012-06-28 17:17:50 TRACE nova Stderr: ''
</span><span class='line'>2012-06-28 17:17:50 TRACE nova
</span><span class='line'>============================================================</span></code></pre></td></tr></table></div></figure>


<p>上面的错误日志是从帖子上抓取的，实际的日志报错都是一样的。上面的问题主要是在nova-rootwrap的权限和默认目录路径上，下面要对rootwrap.conf进行配置\</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nova.conf
</span><span class='line'>
</span><span class='line'>The root_helper parameter is deprecated in favor of the rootwrap_config parameter:
</span><span class='line'>
</span><span class='line'>rootwrap_config=/etc/nova/rootwrap.conf
</span><span class='line'>
</span><span class='line'>If you still want to use root_helper, it now needs to include the configuration file:
</span><span class='line'>
</span><span class='line'>root_helper=sudo nova-rootwrap /etc/nova/rootwrap.conf</span></code></pre></td></tr></table></div></figure>


  
  
  <footer class="meta">
    



    
  </footer>
  
</div>
</article>


	<article class="post"><header>
  
  <h1 class="title"><a href="/blog/2013/08/19/linuxxia-ru-he-mo-ni-an-jian-shu-ru-he-mo-ni-shu-biao/">Linux下如何模拟按键输入和模拟鼠标</a></h1>
  
  








	
		<time datetime="2013-08-19T15:34:00+08:00">
			<span class="day">19</span><span class="month">Aug</span>
		</time>
	

</header>
<div class="entry-content">
  
    <p>1.查看/dev/input/eventX是什么类型的事件， cat /proc/bus/input/devices</p>

<p>设备有着自己特殊的按键键码，我需要将一些标准的按键，比如0－9，X－Z等模拟成标准按键，比如KEY_0,KEY-Z等，所以需要用到按键模拟，具体方法就是操作/dev/input/event1文件，向它写入个input_event结构体就可以模拟按键的输入了。</p>

<pre><code>  linux/input.h中有定义，这个文件还定义了标准按键的编码等
</code></pre>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct input_event {
</span><span class='line'>
</span><span class='line'>struct timeval time; //按键时间
</span><span class='line'>
</span><span class='line'>__u16 type; //类型，在下面有定义
</span><span class='line'>
</span><span class='line'>__u16 code; //要模拟成什么按键
</span><span class='line'>
</span><span class='line'>__s32 value;//是按下还是释放
</span><span class='line'>
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>



  
  
  <footer class="meta">
    



    
  </footer>
  
</div>
</article>


	<article class="post"><header>
  
  <h1 class="title"><a href="/blog/2013/08/19/powershell-huo-qu-xu-ni-ji-zhuang-tai/">POWERSHELL 获取虚拟机状态</a></h1>
  
  








	
		<time datetime="2013-08-19T15:33:00+08:00">
			<span class="day">19</span><span class="month">Aug</span>
		</time>
	

</header>
<div class="entry-content">
  
    <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$allvms = @()
</span><span class='line'>$vms = Get-Vm
</span><span class='line'>foreach($vm in $vms){
</span><span class='line'>  $vmstat = "" | Select VmName, GuestName, NumCPU, ProvisionedSpaceGB, UsedSpaceGB, VmHost, MemMax, MemAvg, CPUMax, CPUAvg, DiskMax, DiskAvg 
</span><span class='line'>  $vmstat.VmName = $vm.name
</span><span class='line'>  $vmstat.GuestName = $vm.Guest.HostName 
</span><span class='line'>  $vmstat.NumCPU = $vm.NumCPU
</span><span class='line'>  $vmstat.ProvisionedSpaceGB = $vm.ProvisionedSpaceGB
</span><span class='line'>  $vmstat.UsedSpaceGB = $vm.UsedSpaceGB
</span><span class='line'>  $vmstat.VmHost = $vm.VMHost
</span><span class='line'>  
</span><span class='line'>  $statcpu = Get-Stat -Entity ($vm) `
</span><span class='line'>           -start (get-date).AddDays(-30) `
</span><span class='line'>           -Finish (Get-Date) `
</span><span class='line'>             -stat cpu.usagemhz.average
</span><span class='line'>  $statmem = Get-Stat -Entity ($vm) `
</span><span class='line'>           -Start (get-date).AddDays(-30) `
</span><span class='line'>           -Finish (Get-Date) `
</span><span class='line'>             -stat mem.consumed.average
</span><span class='line'>  $statdisk = Get-Stat -Entity ($vm) `
</span><span class='line'>           -Start (get-date).AddDays(-30) `
</span><span class='line'>           -Finish (Get-Date) `
</span><span class='line'>             -stat disk.usage.average
</span><span class='line'>
</span><span class='line'>  $cpu = $statcpu | Measure-Object -Property value -Average -Maximum
</span><span class='line'>  $mem = $statmem | Measure-Object -Property value -Average -Maximum
</span><span class='line'>  $disk = $statdisk | Measure-Object -Property value -Average -Maximum
</span><span class='line'>  
</span><span class='line'>  $vmstat.CPUMax = $cpu.Maximum
</span><span class='line'>  $vmstat.CPUAvg = $cpu.Average
</span><span class='line'>  $vmstat.MemMax = $mem.Maximum
</span><span class='line'>  $vmstat.MemAvg = $mem.Average
</span><span class='line'>  $vmstat.DiskMax = $disk.Maximum
</span><span class='line'>  $vmstat.DiskAvg = $disk.Average
</span><span class='line'>  
</span><span class='line'>  $allvms += $vmstat
</span><span class='line'>}
</span><span class='line'>$allvms | Export-Csv "VMs.csv" -noTypeInformation -UseCulture</span></code></pre></td></tr></table></div></figure>


  
  
  <footer class="meta">
    



    
  </footer>
  
</div>
</article>


	<article class="post"><header>
  
  <h1 class="title"><a href="/blog/2013/08/19/powercli-xu-ni-ji-jian-dan-zhuang-tai-bao-gao/">POWERCLI 虚拟机简单状态报告</a></h1>
  
  








	
		<time datetime="2013-08-19T15:17:00+08:00">
			<span class="day">19</span><span class="month">Aug</span>
		</time>
	

</header>
<div class="entry-content">
  
    <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$vms = get-vm|where {$_.name -like "XG*"}
</span><span class='line'>$metrics = "cpu.usagemhz.average","mem.usage.average","cpu.usagemhz.minimum","mem.usage.minimum","cpu.usagemhz.maximum","mem.usage.maximum"
</span><span class='line'>$start = Get-Date -Hour 7 -Minute 0 -Second 0 -Day 7 -Month 8 -Year 2012
</span><span class='line'>$finish = Get-Date -Hour 11 -Minute 0 -Second 0 -Day 9 -Month 8 -Year 2012
</span><span class='line'>Get-Stat -Entity ($vms) -Stat $metrics -Start $start -Finish $finish |
</span><span class='line'>Group-Object -Property EntityId,Timestamp | %{
</span><span class='line'>  New-Object PSObject -Property @{
</span><span class='line'>    VMName = $_.Group[0].Entity.Name
</span><span class='line'>    Date = $_.Group[0].Timestamp.ToLongDateString()
</span><span class='line'>    Time = $_.Group[0].Timestamp.ToLongTimeString()
</span><span class='line'>    MemMax = $_.Group | where {$_.MetricId -eq "mem.usage.maximum"} | Select -ExpandProperty Value
</span><span class='line'>    MemAvg = $_.Group | where {$_.MetricId -eq "mem.usage.average"} | Select -ExpandProperty Value
</span><span class='line'>    MemMin = $_.Group | where {$_.MetricId -eq "mem.usage.minimum"} | Select -ExpandProperty Value
</span><span class='line'>    CpuMax = $_.Group | where {$_.MetricId -eq "cpu.usagemhz.maximum"} | Select -ExpandProperty Value
</span><span class='line'>    CpuMin = $_.Group | where {$_.MetricId -eq "cpu.usagemhz.minimum"} | Select -ExpandProperty Value
</span><span class='line'>    CpuAvg = $_.Group | where {$_.MetricId -eq "cpu.usagemhz.average"} | Select -ExpandProperty Value
</span><span class='line'>    NetMax = $_.Group | where {$_.MetricId -eq "net.usage.maximum" -and $_.Instance -eq ""} | Select -ExpandProperty Value
</span><span class='line'>    NetMin = $_.Group | where {$_.MetricId -eq "net.usage.minimum" -and $_.Instance -eq ""} | Select -ExpandProperty Value
</span><span class='line'>    NetAvg = $_.Group | where {$_.MetricId -eq "net.usage.average" -and $_.Instance -eq ""} | Select -ExpandProperty Value
</span><span class='line'>  }
</span><span class='line'>  } |Export-Csv D:\vmreport.csv -NoTypeInformation -UseCulture</span></code></pre></td></tr></table></div></figure>


  
  
  <footer class="meta">
    



    
  </footer>
  
</div>
</article>


<nav id="pagenavi">
	
	<a href="/blog/page/2/" class="next alignright">Next</a>
 <div class="clearfix"></div>
</nav>
</div>
	<footer id="footer" class="inner"><div class="social alignright">
	
	
	
	
	
	<a class="rss" href="/atom.xml" title="RSS">RSS</a>
</div>
<p>&copy; 2013 GhostBaby</p>
<div class="clearfix"></div></footer>
	<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
	(function($){
		$('.entry-content').each(function(i){
			var _i = i;
			$(this).find('img').each(function(){
				var alt = $(this).attr('alt');

				if (alt == '' || typeof alt == 'undefined'){
					$(this).wrap('<a href="'+$(this).attr('src')+'" class="fancybox" rel="gallery'+_i+'" />');
				} else {
					$(this).after('<span class="caption">'+alt+'</span>').wrap('<a href="'+$(this).attr('src')+'" class="fancybox" title="'+alt+'" rel="gallery'+_i+'" />');
				}
			});
		});
		$('.fancybox').fancybox();
	})(jQuery);
</script>
<div id="phasebeam">
	<canvas></canvas>
	<canvas></canvas>
	<canvas></canvas>
</div>
<script src="/javascripts/phasebeam.js"></script>




</body>
</html>